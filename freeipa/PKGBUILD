# Maintainer: Xiao-Long Chen <chenxiaolong@cxl.epac.to>

# Quite possibly the ugliest PKGBUILD you'll ever see :P

# Based on commit 5e12d2ddce6c65d869defd52578cf8253eccd645 from the fedpkg
# master branch for freeipa.

# NOTE: ntp, autofs, and ntp support is currently broken because the formats of
# the /etc/conf.d/ configuration files in Arch Linux differ from the formats of
# Fedora's /etc/sysconfig/ configuration files.

# Active directory trusts will not (probably never) work in Arch. It requires a
# heavily patched version of Samba 4, which uses MIT Kerberos instead of
# Heimdal. (Fedora went through 174 releases to get this working O_O)

# Client only, for now
build_server=false

# SELinux support
build_selinux=false

# AUR workaround
pkgname=freeipa

pkgbase=freeipa
: && pkgname=('freeipa-client' 'python2-freeipa')

if [ "x${build_server}" == "xtrue" ]; then
  pkgname+=('freeipa-server' 'freeipa-admintools')

  if [ "x${build_selinux}" == "xtrue" ]; then
    pkgname+=('freeipa-server-selinux')
  fi
fi

pkgver=3.2.0
pkgrel=1
pkgdesc="The Identity, Policy, and Audit system"
arch=('i686' 'x86_64')
url="http://www.freeipa.org/"
license=('GPL')

# Client dependencies
makedepends=()

# FreeIPA server dependencies
if [ "x${build_server}" == "xtrue" ]; then
  makedepends+=('389-ds-base'
                'libwbclient'
                'samba'
                'svrcore'
                'systemd'
                'talloc'
                'tevent')

  # SELinux dependencies
  if [ "x${build_selinux}" == "xtrue" ]; then
    makedepends+=('selinux-refpolicy-arch'
                  'selinux-usr-checkpolicy'
                  'selinux-usr-policycoreutils')
  fi
fi

# Other dependencies
makedepends+=('curl'
              'jre7-openjdk'
              'krb5'
              'nspr'
              'nss'
              'openssl'
              'openldap'
              'popt'
              'python2'
              'python2-distribute'
              'python2-dnspython'
              'python2-kerberos'
              'python2-krbv'
              'python2-ldap'
              'python2-lxml'
              'python2-memcached'
              'python2-m2crypto'
              'python2-netaddr'
              'python2-nss'
              'python2-polib'
              'python2-pyasn1'
              'python2-pylint'
              'python2-pyopenssl'
              # Red Hat specific
              #'python2-rhsm'
              'sssd'
              'xmlrpc-c')

# Dependencies for "make check"
checkdepends=('check' 'python2-nose')

options=('!libtool')
source=("http://www.freeipa.org/downloads/src/freeipa-${pkgver}.tar.gz"
        'sss-auth-setup.py'
        'files.freeipa-server'
        'files.freeipa-server-selinux'
        'files.freeipa-admintools'
        'files.freeipa-client'
        'files.python2-freeipa'
        '0001_Use_ArchLinux_Paths.patch'
        '0002_Add_ArchLinux_Platform.patch'
        '0003_Use_Python_2.patch'
        '0004_NTP_Fixes.patch'
        '0005_ntpdate_path.patch'
        '0006_Fix_nss_includes.patch'
        '0007_Disable_make-testcert.patch'
        '0008_Fix_nosetests_path.patch')
sha512sums=('00f14ad80dbd5a411f4a5aa591aab1f11ffcb2aef4d4263d00a0f6129e009afced7c25e87f37558d2372f24f3a4eb1a90dfba60b17bafd223a706ba95fb64416'
            'd70adf5f5339b9eb84b3ecc22e0caa286fb2a411f826d64aae4781c4684bc4d4d4d63ace799029d8318d6d0a2b834e7cc0434a63296497471099877ba2458570'
            'cdc08dad1528ce364ea9e4fa8f4022edb02df7ec5a8ae7c333d0ff5accd8d653eead9c3184737c3b04e901816e6f3ac0905dda34896a7d0287c499b2af84bb18'
            '5182d7a9d25f920c3591bf037dd7ad92bf912db55dc9ac5f1e3fc557c19658515a51270e396aa2614dd7f047b7351cfe281519dc3524f953b495cf9164f836a2'
            'cf9b40b305a004342c40695b635a9eadead90c41197d24c3b96658dc5e992c1748ac3f0262e0c5353e7ddaa3fb2db96143fcd3a6ca7ab34cd737c0d52fad00d6'
            'ae93857dc42f6afb3ec67623b14d3294ad3a21f2ad21e60e245f41ce9fc3ff927ea1820f0783f6f4a5c5bf87d05c3c590fbb441f8dd411bab88be0a29c759897'
            '7baa3920c6bcb0eee3c8c43b65c44a9dbfa56ef511ca878f321be2240f4218e57e73a7b99df86201ced6f2f04bef172dccf1b7d46d54477c0cd86bd8cda3688f'
            '2f80330cca20c57ac552b209ab7cfcbc65595d016198dd6a986fa5255aabec841ce618c3a5203dcfa450b4521da2d67bbda2b7759ff1caad0a868d9ee02774c9'
            '23d9e5ba753344bca51b332f11fad3c909cc3998b7d52d3ad931e10f28b2c172adb8d6b0652b5084c765eddf3d60cc7e6f0be9c0b3e0982eba4bf0409de7a267'
            'e9355816b2b8c9278e87ef8843278176dabf6c6e1cd410cce48d21c70d41b9019a6ea8836c18e47b73d2eca0b794c114c59ad23c5ad89955b627b0e723f9d484'
            '98b8c060bb9c17e927db4c5a5fdd40b022f827082b9da90e035e53f050373b5cd434497f1b31eee3bcbf0a6b471c4a2c0bd155705b06d21deb4d4cfbb8ebc6d0'
            'db9382d0e2bb0c8b85d7bc166714f801dda385a2665f96f7442e745e4bdc944f687b86e5fb27d1d2c8880ee952b5185dd9cf676e57c264e754340cd85b49deec'
            '732bcebdf9795ac38e2e86dccd92a2571714ba080e01a392c782412740a88e35e48b1e968db2ed047462c19d1c89af8c8189408c4ae6f24f2c8b8e9be134fdc2'
            'b58913775e60fe8edd900c42cfc33961c053453c128f3872021713b6dc39ea706480cf3f2ccabd7b2c07aa900cbfda48547c722f8c347fd9ecbd107eecb9fa05'
            'f59422bb5bb511e28c0151afe1d425ecac06130341ef01a922e1595012a8bbc7655b6b711590018406f8cd00ef9702109fdbc74e3e1c13f946ab15d1b3b84a8d')

build() {
  cd "${srcdir}/${pkgbase}-${pkgver}"

  # Apply my patches
  # 0001_Use_ArchLinux_Paths.patch
  #   Change Fedora's paths to the equivalents in Arch Linux
  patch -p1 -i "${srcdir}/0001_Use_ArchLinux_Paths.patch"
  # 0002_Add_ArchLinux_Platform.patch
  #   Make slight changes to Fedora 18's platform code (systemd service names,
  #   /bin/ -> /usr/bin/, etc) and add a minimal Arch Linux platform that
  #   calls most of Fedora 18's platform, except for AuthConfig
  patch -p1 -i "${srcdir}/0002_Add_ArchLinux_Platform.patch"
  # 0003_Use_Python_2.patch
  #   FreeIPA hasn't been ported to Python 3, so the code must be modified to
  #   run /usr/bin/python2
  patch -p1 -i "${srcdir}/0003_Use_Python_2.patch"
  # 0004_NTP_Fixes.patch
  #   Arch Linux's ntp does not accept the '-U' parameter and does not have a
  #   /etc/sysconfig/ configuration files, so the relevant code must be removed
  patch -p1 -i "${srcdir}/0004_NTP_Fixes.patch"
  # 0005_ntpdate_path.patch
  #   Arch Linux's ntp package puts ntpdate in /usr/bin/ instead of /usr/sbin/
  patch -p1 -i "${srcdir}/0005_ntpdate_path.patch"
  # 0006_Fix_nss_includes.patch
  #   Arch Linux's nss package installs the header files to /usr/include/nss/
  #   instead of /usr/include/nss3/
  patch -p1 -i "${srcdir}/0006_Fix_nss_includes.patch"
  # 0007_Disable_make-testcert.patch
  #   make-testcert requires a running certificate server to work properly
  patch -p1 -i "${srcdir}/0007_Disable_make-testcert.patch"
  # 0008_Fix_nosetests_path.patch
  #   Arch Linux's python2-nose package installs nosetests as
  #   /usr/bin/nosetests2
  patch -p1 -i "${srcdir}/0008_Fix_nosetests_path.patch"

  export SUPPORTED_PLATFORM=archlinux
  export PYTHON=python2

  # Force regeneration of platform support
  rm ipapython/services.py

  make version-update

  pushd ipa-client
  ../autogen.sh --prefix=/usr --sysconfdir=/etc
  popd

  if [ "x${build_server}" == "xtrue" ]; then
    pushd daemons
    ../autogen.sh --prefix=/usr --sysconfdir=/etc --with-openldap
    popd

    pushd install
    ../autogen.sh --prefix=/usr --sysconfdir=/etc
    popd

    make IPA_VERSION_IS_GIT_SNAPSHOT=no all

    if [ "x${build_selinux}" == "xtrue" ]; then
      pushd selinux
      make -j1 all
      popd
    fi
  else
    make IPA_VERSION_IS_GIT_SNAPSHOT=no client
  fi

  # Install to temporary directory #############################################

  export SUPPORTED_PLATFORM=archlinux

  # Force regeneration of platform support
  rm ipapython/services.py

  if [ "x${build_server}" == "xtrue" ]; then
    make install DESTDIR="${srcdir}/install_temp"

    if [ "x${build_selinux}" == "xtrue" ]; then
      pushd selinux
      make install DESTDIR="${srcdir}/install_temp"
      popd
    fi
  else
    make client-install DESTDIR="${srcdir}/install_temp"
  fi

  if [ "x${build_server}" == "xtrue" ]; then
    # Some user-modifiable HTML files are provided. Move these to /etc and link
    # back.
    install -dm755 "${srcdir}/install_temp/etc/ipa/html/"
    install -dm755 "${srcdir}/install_temp/var/cache/ipa/sysrestore/"
    install -dm755 "${srcdir}/install_temp/var/cache/ipa/sysupgrade/"
    install -dm755 "${srcdir}/install_temp/var/cache/ipa/pki-ca/publish/"
    install -dm755 "${srcdir}/install_temp/usr/share/ipa/html/"
    ln -s ../../../../etc/ipa/html/ffconfig.js \
      "${srcdir}/install_temp/usr/share/ipa/html/ffconfig.js"
    ln -s ../../../../etc/ipa/html/ffconfig_page.js \
      "${srcdir}/install_temp/usr/share/ipa/html/ffconfig_page.js"
    ln -s ../../../../etc/ipa/html/ssbrowser.html \
      "${srcdir}/install_temp/usr/share/ipa/html/ssbrowser.html"
    ln -s ../../../../etc/ipa/html/unauthorized.html \
      "${srcdir}/install_temp/usr/share/ipa/html/unauthorized.html"
    ln -s ../../../../etc/ipa/html/browserconfig.html \
      "${srcdir}/install_temp/usr/share/ipa/html/browserconfig.html"
    ln -s ../../../../etc/ipa/html/ipa_error.css \
      "${srcdir}/install_temp/usr/share/ipa/html/ipa_error.css"

    # So we can own our Apache configuration
    install -dm755 "${srcdir}/install_temp/etc/httpd/conf/extra/"
    touch "${srcdir}/install_temp/etc/httpd/conf/extra/ipa.conf"
    touch "${srcdir}/install_temp/etc/httpd/conf/extra/ipa-pki-proxy.conf"
    touch "${srcdir}/install_temp/etc/httpd/conf/extra/ipa-rewrite.conf"
    install -dm755 "${srcdir}/install_temp/usr/share/ipa/html/"
    touch "${srcdir}/install_temp/usr/share/ipa/html/ca.crt"
    touch "${srcdir}/install_temp/usr/share/ipa/html/configure.jar"
    touch "${srcdir}/install_temp/usr/share/ipa/html/kerberosauth.xpi"
    touch "${srcdir}/install_temp/usr/share/ipa/html/krb.con"
    touch "${srcdir}/install_temp/usr/share/ipa/html/krb.js"
    touch "${srcdir}/install_temp/usr/share/ipa/html/krb5.ini"
    touch "${srcdir}/install_temp/usr/share/ipa/html/krbrealm.con"
    touch "${srcdir}/install_temp/usr/share/ipa/html/preferences.html"

    # systemd service
    install -dm755 "${srcdir}/install_temp/usr/lib/systemd/system/"
    install -m644 \
      init/systemd/ipa.service \
      init/systemd/ipa_memcached.service \
      "${srcdir}/install_temp/usr/lib/systemd/system/"

    # Configuration files
    install -dm755 "${srcdir}/install_temp/etc/conf.d/"
    install -m644 init/ipa_memcached.conf \
      "${srcdir}/install_temp/etc/conf.d/"

    # /run
    install -dm755 "${srcdir}/install_temp/run/"
    install -dm700 "${srcdir}/install_temp/run/ipa/"
    install -dm700 "${srcdir}/install_temp/run/ipa_memcached/"

    # krb5 plugins
    install -dm755 "${srcdir}/install_temp/usr/lib/krb5/plugins/libkrb5/"
    touch "${srcdir}/install_temp/usr/lib/krb5/plugins/libkrb5/winbind_krb5_locator.so"

    # systemd tmpfiles.d configuration
    install -dm755 "${srcdir}/install_temp/usr/lib/tmpfiles.d/"
    install -m644 init/systemd/ipa.conf.tmpfiles \
      "${srcdir}/install_temp/usr/lib/tmpfiles.d/ipa.conf"

    # bash completion configuration files
    install -dm755 "${srcdir}/install_temp/etc/bash_completion.d/"
    install -m644 contrib/completion/ipa.bash_completion \
      "${srcdir}/install_temp/etc/bash_completion.d/ipa"

    # cron files
    install -dm755 "${srcdir}/install_temp/etc/cron.d/"
    install -m644 ipa-compliance.cron "${srcdir}/etc/cron.d/ipa-compliance"

    # Web UI plugin dir
    install -dm755 "${srcdir}/install_temp/usr/share/ipa/ui/js/plugins/"

    # Backup directory
    install -dm755 "${srcdir}/install_temp/var/lib/ipa/backup/"
  fi

  install -dm755 "${srcdir}/install_temp/var/lib/ipa-client/sysrestore/"

  # /etc/ipa/ is needed for ipa-client-install
  install -dm755 "${srcdir}/install_temp/etc/ipa/"

  # Fix filenames
  pushd "${srcdir}/install_temp/usr/lib/python2.7/site-packages/"
  mv ipapython-${pkgver}*-py2.7.egg-info ipapython-${pkgver}-py2.7.egg-info
  popd

  find "${srcdir}/install_temp/" \( -name '*.pyc' -o -name '*.pyo' \) -delete
}

check() {
  cd "${srcdir}/${pkgbase}-${pkgver}"
  # Tests require FreeIPA to be installed and set up
  #make test
}

install_file() {
  if [ -z "${1}" ]; then
    error "No path specified!"
    exit 1
  fi
  if [ ! -e "${srcdir}/install_temp/${1}" ]; then
    error "${1} does not exist!"
    exit 1
  fi
  if [ -d "${srcdir}/install_temp/${1}/" ]; then
    if [ -d "${pkgdir}/${1}/" ]; then
      error "Directory ${1} already exists!"
      exit 1
    fi
  fi
  if [ -f "${srcdir}/install_temp/${1}" ]; then
    if [ -f "${pkgdir}/${1}" ]; then
      error "File ${1} already exists!"
      exit 1
    fi
  fi
  if [ ! -d "${pkgdir}/$(dirname ${1})/" ]; then
    install -dm755 "${pkgdir}/$(dirname ${1})/"
  fi

  # Set permissions
  if echo "${1}" | grep -q ':'; then
    local FILE=${1#*:}
    local PERM=${1%:*}
    mv "${srcdir}/install_temp/${FILE}" "${pkgdir}/${FILE}"
    chmod ${PERM} "${pkgdir}/${FILE}"
  else
    mv "${srcdir}/install_temp/${1}" "${pkgdir}/${1}"
  fi
}

install_files() {
  if [ ! -f "${srcdir}/files.${1}" ]; then
    error "${srcdir}/files.${1} not found!"
    exit 1
  fi
  while read FILE; do
    if echo "${FILE}" | grep -q -e '#' -e '^[ \t]*$'; then
      continue
    fi
    msg "Installing file: ${FILE}"
    install_file ${FILE}
  done < "${srcdir}/files.${1}"
}

if [ "x${build_server}" == "xtrue" ]; then

package_freeipa-server() {
  : && pkgdesc="The IPA authentication server"
  depends=("freeipa-admintools=${pkgver}-${pkgrel}"
           "freeipa-client=${pkgver}-${pkgrel}"
           "python2-freeipa=${pkgver}-${pkgrel}"
           '389-ds-base'
           'acl'
           'apache'
           'cyrus-sasl-gssapi'
           'keyutils'
           'krb5'
           'memcached'
           'mod_auth_kerb'
           'mod_nss'
           'mod_wsgi'
           'nss'
           'ntp'
           'openldap'
           'python2-dnspython'
           'python2-krbv'
           'python2-ldap'
           'python2-memcached'
           'python2-pyasn1'
           'slapi-nis'
           'systemd'
           'tomcat7'
           'zip')
  optdepends=('python2-m2crypto: For Microsoft Active Directory trusts'
              'samba: For Microsoft Active Directory trusts'
              'sssd: For Microsoft Active Directory trusts')
  backup=('etc/ipa/html/browserconfig.html'
          'etc/ipa/html/ffconfig.js'
          'etc/ipa/html/ffconfig_page.js'
          'etc/ipa/html/ipa_error.css'
          'etc/ipa/html/ssbrowser.html'
          'etc/ipa/html/unauthorized.html')
  # Backup files created by this package
  backup+=('etc/httpd/conf/extra/ipa-rewrite.conf'
           'etc/httpd/conf/extra/ipa.conf'
           'etc/httpd/conf/extra/ipa-pki-proxy.conf'
           'usr/share/ipa/html/ca.crt')
  install=install.freeipa-server

  # SELinux dependencies
  if [ "x${build_selinux}" == "xtrue" ]; then
    depends+=("freeipa-server-selinux=${pkgver}-${pkgrel}"
              'selinux-refpolicy-arch'
              'selinux-usr-policycoreutils')
  fi

  # Conflicts with mod_ssl, but that is a part of the apache package
  #conflicts=('mod_ssl')

  install_files freeipa-server
}

if [ "x${build_selinux}" == "xtrue" ]; then

package_freeipa-server-selinux() {
  : && pkgdesc="SELinux rules for freeipa-server daemons"
  depends=("freeipa-server=${pkgver}-${pkgrel}"
           'selinux-usr-policycoreutils')
  install=install.freeipa-server-selinux

  install_files freeipa-server-selinux
}


fi

package_freeipa-admintools() {
  : && pkgdesc="IPA administrative tools"
  depends=("freeipa-client=${pkgver}-${pkgrel}"
           "python2-freeipa=${pkgver}-${pkgrel}"
           'python2-krbv'
           'python2-ldap')

  install_files freeipa-admintools
}

fi

package_freeipa-client() {
  : && pkgdesc="IPA authentication for use on clients"
  depends=("python2-freeipa=${pkgver}-${pkgrel}"
           'autofs'
           'bind'
           'certmonger'
           'curl-gssapi'
           'cyrus-sasl-gssapi'
           'nfs-utils'
           'nfsidmap'
           'nss'
           'ntp'
           'oddjob'
           'pam-krb5'
           'python2-dnspython'
           'python2-krbv'
           'python2-ldap'
           'sssd'
           'wget'
           'xmlrpc-c')

  # authconfig is Fedora specific
  #depends+=('authconfig')

  install_files freeipa-client

  install -dm755 "${pkgdir}/usr/sbin/"
  install -m755 "${srcdir}/sss-auth-setup.py" \
                "${pkgdir}/usr/sbin/sss-auth-setup"
}

package_python2-freeipa() {
  : && pkgdesc="Python 2 libraries used by IPA"
  depends=('gnupg'
           'iproute2'
           'python2-kerberos'
           'python2-lxml'
           'python2-netaddr'
           'python2-nss'
           'python2-pyopenssl'
           'sssd')
  # Backup files created by this package
  backup=('etc/ipa/default.conf'
          'etc/ipa/ca.crt')

  install_files python2-freeipa
}

# vim:set ts=2 sw=2 et:
